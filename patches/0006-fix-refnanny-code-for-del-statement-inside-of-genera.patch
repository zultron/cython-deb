From 5827f4c9bcfe6b9030358727c1ca3197425e576e Mon Sep 17 00:00:00 2001
From: Stefan Behnel <stefan_ml@behnel.de>
Date: Fri, 30 Nov 2012 13:30:31 +0100
Subject: [PATCH 6/6] fix refnanny code for del statement inside of generators

---
 Cython/Compiler/ExprNodes.py |  2 ++
 tests/run/generators_py.py   | 12 ++++++++++++
 2 files changed, 14 insertions(+)

diff --git a/Cython/Compiler/ExprNodes.py b/Cython/Compiler/ExprNodes.py
index 06fc30d..df4bff7 100755
--- a/Cython/Compiler/ExprNodes.py
+++ b/Cython/Compiler/ExprNodes.py
@@ -1861,6 +1861,8 @@ class NameNode(AtomicExprNode):
                     code.put_error_if_unbound(self.pos, self.entry)
 
                 if self.entry.type.is_pyobject:
+                    if self.entry.in_closure:
+                        code.put_gotref(self.result()) # generator
                     code.put_decref(self.result(), self.ctype())
                     code.putln('%s = NULL;' % self.result())
                 else:
diff --git a/tests/run/generators_py.py b/tests/run/generators_py.py
index f044eb1..3159d52 100644
--- a/tests/run/generators_py.py
+++ b/tests/run/generators_py.py
@@ -350,3 +350,15 @@ def test_generator_cleanup():
         yield 1
     finally:
         print('cleanup')
+
+def test_del_in_generator():
+    """
+    >>> [ s for s in test_del_in_generator() ]
+    ['abcabcabc', 'abcabcabc']
+    """
+    x = len('abc') * 'abc'
+    a = x
+    yield x
+    del x
+    yield a
+    del a
-- 
1.8.0

